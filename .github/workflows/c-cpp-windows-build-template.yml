# SPDX-FileCopyrightText: Copyright (C) 2025 FabrÃ­cio Barros Cabral
# SPDX-License-Identifier: MIT
---
# yamllint disable rule:line-length
name: c-cpp-windows-build-template
'on':
  workflow_call:
    inputs:
      working-directory:
        description: "Set the working directory"
        required: false
        default: "."
        type: string
defaults:
  run:
    shell: msys2 {0}
permissions:
  contents: read
jobs:
  c-cpp-windows-build-template:
    runs-on: windows-2025
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false
      - name: Install and setup MSYS2 with MinGW64
        uses: msys2/setup-msys2@v2.30.0
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            autoconf
            automake
            libtool
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-make
            mingw-w64-x86_64-pkgconf
      - name: Configure and build
        working-directory: ${{ inputs.working-directory }}
        run: |
          [[ -x ./autogen.sh ]] && ./autogen.sh
          [[ -x ./configure ]] && ./configure --host=x86_64-w64-mingw64
          [[ -s Makefile ]] || {
            echo "I couldn't find an autogen.sh, configure, or Makefile."
            echo "Please check your files."
            exit 1
          }
          make
      - name: Get properties from configure.ac
        working-directory: ${{ inputs.working-directory }}
        id: props
        run: |
          name="$(sed -n 's/AC_INIT(\[\([^]]*\)\],.*/\1/p' configure.ac)"
          echo "name=${name}" >> "${GITHUB_OUTPUT}"
          version="$(sed -n 's/AC_INIT(\[[^]]*\], \[\([^]]*\)\], \[[^]]*\])/\1/p' configure.ac)"
          echo "version=${version}" >> "${GITHUB_OUTPUT}"
      - name: Create source package
        working-directory: ${{ inputs.working-directory }}
        run: |
          make dist
      - name: Create Windows binary package
        working-directory: ${{ inputs.working-directory }}
        run: |
          make binary-dist
      - name: Prepare packages to distribution
        working-directory: ${{ inputs.working-directory }}
        env:
          NAME: ${{ steps.props.outputs.name }}
          VERSION: ${{ steps.props.outputs.version }}
        run: |
          mkdir dist
          mv "${NAME}-${VERSION}-bin.tar.gz" \
            "dist/${NAME}-${VERSION}-windows.tar.gz"
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v6
        env:
          WORKING_DIR: ${{ inputs.working-directory }}
        with:
          name: windows-dist
          path: "${WORKING_DIR}/dist/*.tar.gz"
